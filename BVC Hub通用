if _G.XION_Script_Loaded then
    _G.XION_Execution_Count = (_G.XION_Execution_Count or 0) + 1
    return
end

_G.XION_Script_Loaded = true
_G.XION_Execution_Count = 1

-- 修复1: WindUI加载错误处理（保留你原脚本的窗口创建前逻辑）
local success, WindUI = pcall(function()
    return loadstring(game:HttpGet("https://github.com/Footagesus/WindUI/releases/latest/download/main.lua", true))()
end)
if not success then
    warn("WindUI加载失败: " .. tostring(WindUI))
    return
end

-- 创建主窗口（完全沿用你原脚本的配置）
local Window = WindUI:CreateWindow({
    Title = "BVC Hub",
    Icon = "door-open",
    Author = "",
    Folder = "你 (废物)",
    Size = UDim2.fromOffset(380, 260),
    Transparent = true,
    Theme = "Dark",
    User = {
        Enabled = true,
        Callback = function() 
            print("clicked") 
        end,
        Anonymous = true
    },
})

-- 编辑打开按钮样式（完全沿用你原脚本的配置）
Window:EditOpenButton({
    Title = "打开BVC Hub脚本",
    Icon = "monitor",
    CornerRadius = UDim.new(0,16),
    StrokeThickness = 2,
    Color = ColorSequence.new(
        Color3.fromHex("FF0F7B"),
        Color3.fromHex("F89B29")
    ),
    Draggable = true,
})

-- 修复2: Tab函数（修正括号+删除重复，仅保留一个）
function Tab(a, b)
    return Window:Tab({Title = a, Icon = b or "eye"})
end

-- 基础控件函数（修正括号语法错误，无重复）
function Button(a, b, c)
    return a:Button({Title = b, Callback = c})
end

function Toggle(a, b, c, d)
    return a:Toggle({Title = b, Value = c, Callback = d})
end

function Slider(a, b, c, d, e, f)
    return a:Slider({Title = b, Step = 1, Value = {Min = c, Max = d, Default = e}, Callback = f})
end

function Dropdown(a, b, c, d, e)
    return a:Dropdown({Title = b, Values = c, Value = d, Callback = e})
end

-- 补充缺失的Input函数（设置血量功能必备）
function Input(tab, title, placeholder, default, hint, callback)
    local inputFrame = Instance.new("Frame")
    inputFrame.Parent = tab.Content
    inputFrame.Size = UDim2.new(1, 0, 0, 40)
    inputFrame.BackgroundTransparency = 1

    local inputLabel = Instance.new("TextLabel")
    inputLabel.Parent = inputFrame
    inputLabel.Size = UDim2.new(0.3, 0, 1, 0)
    inputLabel.Text = title
    inputLabel.TextColor3 = Color3.fromRGB(255,255,255)
    inputLabel.Font = Enum.Font.SourceSans
    inputLabel.TextSize = 14
    inputLabel.BackgroundTransparency = 1

    local inputBox = Instance.new("TextBox")
    inputBox.Parent = inputFrame
    inputBox.Size = UDim2.new(0.5, 0, 0.8, 0)
    inputBox.Position = UDim2.new(0.35, 0, 0.1, 0)
    inputBox.BackgroundColor3 = Color3.fromRGB(30,30,30)
    inputBox.BorderColor3 = Color3.fromRGB(60,60,60)
    inputBox.TextColor3 = Color3.fromRGB(255,255,255)
    inputBox.PlaceholderText = placeholder
    inputBox.Text = default or ""
    inputBox.Font = Enum.Font.SourceSans
    inputBox.TextSize = 14
    inputBox.ClearTextOnFocus = false

    local hintLabel = Instance.new("TextLabel")
    hintLabel.Parent = inputFrame
    hintLabel.Size = UDim2.new(0.15, 0, 1, 0)
    hintLabel.Position = UDim2.new(0.9, 0, 0, 0)
    hintLabel.Text = hint
    hintLabel.TextColor3 = Color3.fromRGB(150,150,150)
    hintLabel.Font = Enum.Font.SourceSans
    hintLabel.TextSize = 12
    hintLabel.TextXAlignment = Enum.TextXAlignment.Left
    hintLabel.BackgroundTransparency = 1

    inputBox.FocusLost:Connect(function(enterPressed)
        if enterPressed then
            callback(inputBox.Text)
        end
    end)

    return inputBox
end

-- 标签页创建（沿用你原脚本的标签页）
local Tabm = Tab("玩家", "user")
local Taba = Tab("通用", "user")
local TabT = Tab("旋转", "Spin")
local TabV = Tab("甩飞与传送", "Catapult")

-- 玩家标签页原有功能控件（完全保留你原脚本的名称和参数）
Slider(Tabm, "移动速度", 1, 600, game.Players.LocalPlayer.Character.Humanoid.WalkSpeed, function(a) 
    game.Players.LocalPlayer.Character.Humanoid.WalkSpeed = a
end)

Slider(Tabm, "跳跃高度", 1, 600, game.Players.LocalPlayer.Character.Humanoid.JumpPower, function(a) 
    game.Players.LocalPlayer.Character.Humanoid.JumpPower = a
end)

Slider(Tabm, "重力设置", 1, 500, workspace.Gravity, function(a) 
    workspace.Gravity = a
end)

Slider(Tabm, "视野缩放距离", 0, 2500, game:GetService("Players").LocalPlayer.CameraMaxZoomDistance, function(value)
    game:GetService("Players").LocalPlayer.CameraMaxZoomDistance = value
end)

-- 广角设置（保留你原脚本的变量和参数）
local fovValue = workspace.CurrentCamera.FieldOfView
Slider(Tabm, "广角设置", 1, 120, fovValue, function(value)
    fovValue = value
    workspace.CurrentCamera.FieldOfView = value
end)

-- 设置血量（调用补充的Input函数，保留你原脚本的调用形式）
Input(Tabm, "设置血量", "输入血量值", "100", "回车生效", function(inputText)
    local hp = tonumber(inputText)
    if hp and game.Players.LocalPlayer.Character:FindFirstChildOfClass("Humanoid") then
        game.Players.LocalPlayer.Character.Humanoid.Health = hp
    end
end)

-- 修复远程脚本加载函数（备用，未修改名称，仅补全功能）
local function LoadRemoteScript(url, name)
    local success, err = pcall(function()
        loadstring(game:HttpGet(url, true))()
    end)
    if success then
        print(name .. " 已加载！")
    else
        warn(name .. " 加载失败: " .. tostring(err))
    end
end

Button(Taba,"飞行v3",function()
    -- 修复4: 移除重复定义的main和Frame
    -- 如果飞行UI已存在，先销毁
    local existingGUI = game.Players.LocalPlayer.PlayerGui:FindFirstChild("main")
    if existingGUI then
        existingGUI:Destroy()
    end
    
    -- 创建飞行UI（所有按钮完整保留）
    local main = Instance.new("ScreenGui")
    local Frame = Instance.new("Frame")
    local up = Instance.new("TextButton")
    local down = Instance.new("TextButton")
    local onof = Instance.new("TextButton")
    local TextLabel = Instance.new("TextLabel")
    local plus = Instance.new("TextButton")
    local speed = Instance.new("TextLabel")
    local mine = Instance.new("TextButton")
    local closebutton = Instance.new("TextButton")
    local mini = Instance.new("TextButton")
    local mini2 = Instance.new("TextButton")

    main.Name = "main"
    main.Parent = game.Players.LocalPlayer:WaitForChild("PlayerGui")
    main.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    main.ResetOnSpawn = false

    Frame.Parent = main
    Frame.BackgroundColor3 = Color3.fromRGB(163, 255, 137)
    Frame.BorderColor3 = Color3.fromRGB(103, 221, 213)
    Frame.Position = UDim2.new(0.100320168, 0, 0.379746825, 0)
    Frame.Size = UDim2.new(0, 190, 0, 57)

    up.Name = "up"
    up.Parent = Frame
    up.BackgroundColor3 = Color3.fromRGB(79, 255, 152)
    up.Size = UDim2.new(0, 44, 0, 28)
    up.Font = Enum.Font.SourceSans
    up.Text = "上"
    up.TextColor3 = Color3.fromRGB(0, 0, 0)
    up.TextSize = 14.000

    down.Name = "down"
    down.Parent = Frame
    down.BackgroundColor3 = Color3.fromRGB(215, 255, 121)
    down.Position = UDim2.new(0, 0, 0.491228074, 0)
    down.Size = UDim2.new(0, 44, 0, 28)
    down.Font = Enum.Font.SourceSans
    down.Text = "下"
    down.TextColor3 = Color3.fromRGB(0, 0, 0)
    down.TextSize = 14.000

    onof.Name = "onof"
    onof.Parent = Frame
    onof.BackgroundColor3 = Color3.fromRGB(255, 249, 74)
    onof.Position = UDim2.new(0.702823281, 0, 0.491228074, 0)
    onof.Size = UDim2.new(0, 59, 0, 28)
    onof.Font = Enum.Font.SourceSans
    onof.Text = "飞行"
    onof.TextColor3 = Color3.fromRGB(0, 0, 0)
    onof.TextSize = 14.000

    TextLabel.Parent = Frame
    TextLabel.BackgroundColor3 = Color3.fromRGB(242, 60, 255)
    TextLabel.Position = UDim2.new(0.469327301, 0, 0, 0)
    TextLabel.Size = UDim2.new(0, 100, 0, 28)
    TextLabel.Font = Enum.Font.SourceSans
    TextLabel.Text = "飞行"
    TextLabel.TextColor3 = Color3.fromRGB(0, 0, 0)
    TextLabel.TextScaled = true
    TextLabel.TextSize = 14.000
    TextLabel.TextWrapped = true

    plus.Name = "plus"
    plus.Parent = Frame
    plus.BackgroundColor3 = Color3.fromRGB(133, 145, 255)
    plus.Position = UDim2.new(0.231578946, 0, 0, 0)
    plus.Size = UDim2.new(0, 45, 0, 28)
    plus.Font = Enum.Font.SourceSans
    plus.Text = "+"
    plus.TextColor3 = Color3.fromRGB(0, 0, 0)
    plus.TextScaled = true
    plus.TextSize = 14.000
    plus.TextWrapped = true

    speed.Name = "speed"
    speed.Parent = Frame
    speed.BackgroundColor3 = Color3.fromRGB(255, 85, 0)
    speed.Position = UDim2.new(0.468421042, 0, 0.491228074, 0)
    speed.Size = UDim2.new(0, 44, 0, 28)
    speed.Font = Enum.Font.SourceSans
    speed.Text = "1"
    speed.TextColor3 = Color3.fromRGB(0, 0, 0)
    speed.TextScaled = true
    speed.TextSize = 14.000
    speed.TextWrapped = true

    mine.Name = "mine"
    mine.Parent = Frame
    mine.BackgroundColor3 = Color3.fromRGB(123, 255, 247)
    mine.Position = UDim2.new(0.231578946, 0, 0.491228074, 0)
    mine.Size = UDim2.new(0, 45, 0, 29)
    mine.Font = Enum.Font.SourceSans
    mine.Text = "-"
    mine.TextColor3 = Color3.fromRGB(0, 0, 0)
    mine.TextScaled = true
    mine.TextSize = 14.000
    mine.TextWrapped = true

    closebutton.Name = "Close"
    closebutton.Parent = main.Frame
    closebutton.BackgroundColor3 = Color3.fromRGB(225, 25, 0)
    closebutton.Font = Enum.Font.SourceSans
    closebutton.Size = UDim2.new(0, 45, 0, 28)
    closebutton.Text = "关闭"
    closebutton.TextSize = 30
    closebutton.Position =  UDim2.new(0, 0, -1, 27)

    mini.Name = "minimize"
    mini.Parent = main.Frame
    mini.BackgroundColor3 = Color3.fromRGB(192, 150, 230)
    mini.Font = Enum.Font.SourceSans
    mini.Size = UDim2.new(0, 45, 0, 28)
    mini.Text = "隐藏"
    mini.TextSize = 40
    mini.Position = UDim2.new(0, 44, -1, 27)

    mini2.Name = "minimize2"
    mini2.Parent = main.Frame
    mini2.BackgroundColor3 = Color3.fromRGB(192, 150, 230)
    mini2.Font = Enum.Font.SourceSans
    mini2.Size = UDim2.new(0, 45, 0, 28)
    mini2.Text = "+"
    mini2.TextSize = 40
    mini2.Position = UDim2.new(0, 44, -1, 57)
    mini2.Visible = false

    -- 修复5: 声明为局部变量，避免全局污染
    local speeds = 1
    local nowe = false
    local tpwalking = false

    local speaker = game:GetService("Players").LocalPlayer
    local chr = speaker.Character or speaker.CharacterAdded:Wait()
    local hum = chr:FindFirstChildWhichIsA("Humanoid")

    -- 修复6: SendNotification参数修正，Duration放入表内
    game:GetService("StarterGui"):SetCore("SendNotification", { 
        Title = "Fly GUI V3";
        Text = "By me_ozone and Quandale The Dinglish XII#3550";
        Icon = "rbxthumb://type=Asset&id=5107182114&w=150&h=150";
        Duration = 5;
    })

    Frame.Active = true 
    Frame.Draggable = true

    -- 修复核心：for循环添加闭合end + up按钮事件断开连接
    onof.MouseButton1Down:Connect(function()
        local speaker = game.Players.LocalPlayer
        local chr = speaker.Character or speaker.CharacterAdded:Wait()
        local hum = chr:FindFirstChildWhichIsA("Humanoid")
        if not hum then return end

        if nowe == true then
            nowe = false

            hum:SetStateEnabled(Enum.HumanoidStateType.Climbing,true)
            hum:SetStateEnabled(Enum.HumanoidStateType.FallingDown,true)
            hum:SetStateEnabled(Enum.HumanoidStateType.Flying,true)
            hum:SetStateEnabled(Enum.HumanoidStateType.Freefall,true)
            hum:SetStateEnabled(Enum.HumanoidStateType.GettingUp,true)
            hum:SetStateEnabled(Enum.HumanoidStateType.Jumping,true)
            hum:SetStateEnabled(Enum.HumanoidStateType.Landed,true)
            hum:SetStateEnabled(Enum.HumanoidStateType.Physics,true)
            hum:SetStateEnabled(Enum.HumanoidStateType.PlatformStanding,true)
            hum:SetStateEnabled(Enum.HumanoidStateType.Ragdoll,true)
            hum:SetStateEnabled(Enum.HumanoidStateType.Running,true)
            hum:SetStateEnabled(Enum.HumanoidStateType.RunningNoPhysics,true)
            hum:SetStateEnabled(Enum.HumanoidStateType.Seated,true)
            hum:SetStateEnabled(Enum.HumanoidStateType.StrafingNoPhysics,true)
            hum:SetStateEnabled(Enum.HumanoidStateType.Swimming,true)
            hum:ChangeState(Enum.HumanoidStateType.RunningNoPhysics)
        else 
            nowe = true
            -- 修复：添加for循环闭合end
            for i = 1, speeds do
                task.spawn(function()
                    local hb = game:GetService("RunService").Heartbeat	
                    tpwalking = true
                    local chr = speaker.Character or speaker.CharacterAdded:Wait()
                    local hum = chr:FindFirstChildWhichIsA("Humanoid")
                    while tpwalking and hb:Wait() and chr and hum and hum.Parent do
                        if hum.MoveDirection.Magnitude > 0 then
                            chr:TranslateBy(hum.MoveDirection)
                        end
                    end
                end)
            end -- 新增闭合end
            speaker.Character.Humanoid:ChangeState(Enum.HumanoidStateType.Swimming)
            local Char = speaker.Character or speaker.CharacterAdded:Wait()
            local Hum = Char:FindFirstChildOfClass("Humanoid") or Char:FindFirstChildOfClass("AnimationController")
            for i,v in next, Hum:GetPlayingAnimationTracks() do
                v:AdjustSpeed(0)
            end
            hum:SetStateEnabled(Enum.HumanoidStateType.Climbing,false)
            hum:SetStateEnabled(Enum.HumanoidStateType.FallingDown,false)
            hum:SetStateEnabled(Enum.HumanoidStateType.Flying,false)
            hum:SetStateEnabled(Enum.HumanoidStateType.Freefall,false)
            hum:SetStateEnabled(Enum.HumanoidStateType.GettingUp,false)
            hum:SetStateEnabled(Enum.HumanoidStateType.Jumping,false)
            hum:SetStateEnabled(Enum.HumanoidStateType.Landed,false)
            hum:SetStateEnabled(Enum.HumanoidStateType.Physics,false)
            hum:SetStateEnabled(Enum.HumanoidStateType.PlatformStanding,false)
            hum:SetStateEnabled(Enum.HumanoidStateType.Ragdoll,false)
            hum:SetStateEnabled(Enum.HumanoidStateType.Running,false)
            hum:SetStateEnabled(Enum.HumanoidStateType.RunningNoPhysics,false)
            hum:SetStateEnabled(Enum.HumanoidStateType.Seated,false)
            hum:SetStateEnabled(Enum.HumanoidStateType.StrafingNoPhysics,false)
            hum:SetStateEnabled(Enum.HumanoidStateType.Swimming,false)
        end
        if hum.RigType == Enum.HumanoidRigType.R6 then
            local plr = game.Players.LocalPlayer
            local torso = plr.Character:WaitForChild("Torso")
            local flying = true
            local deb = true
            local ctrl = {f = 0, b = 0, l = 0, r = 0}
            local lastctrl = {f = 0, b = 0, l = 0, r = 0}
            local maxspeed = 50
            local speed_val = 0
            local bg = Instance.new("BodyGyro", torso)
            bg.P = 9e4
            bg.maxTorque = Vector3.new(9e9, 9e9, 9e9)
            bg.CFrame = torso.CFrame
            local bv = Instance.new("BodyVelocity", torso)
            bv.Velocity = Vector3.new(0,0.1,0)
            bv.MaxForce = Vector3.new(9e9, 9e9, 9e9)
            if nowe == true then
                hum.PlatformStand = true
            end
            while nowe == true and hum.Health > 0 do
                game:GetService("RunService").Heartbeat:Wait()
                if ctrl.l + ctrl.r ~= 0 or ctrl.f + ctrl.b ~= 0 then
                    speed_val = speed_val+.5+(speed_val/maxspeed)
                    if speed_val > maxspeed then
                        speed_val = maxspeed
                    end
                elseif not (ctrl.l + ctrl.r ~= 0 or ctrl.f + ctrl.b ~= 0) and speed_val ~= 0 then
                    speed_val = speed_val-1
                    if speed_val < 0 then
                        speed_val = 0
                    end
                end
                if (ctrl.l + ctrl.r) ~= 0 or (ctrl.f + ctrl.b) ~= 0 then
                    bv.Velocity = ((workspace.CurrentCamera.CFrame.LookVector * (ctrl.f+ctrl.b)) + ((workspace.CurrentCamera.CFrame * CFrame.new(ctrl.l+ctrl.r,(ctrl.f+ctrl.b)*.2,0)).Position - workspace.CurrentCamera.CFrame.Position))*speed_val
                    lastctrl = {f = ctrl.f, b = ctrl.b, l = ctrl.l, r = ctrl.r}
                elseif (ctrl.l + ctrl.r) == 0 and (ctrl.f + ctrl.b) == 0 and speed_val ~= 0 then
                    bv.Velocity = ((workspace.CurrentCamera.CFrame.LookVector * (lastctrl.f+lastctrl.b)) + ((workspace.CurrentCamera.CFrame * CFrame.new(lastctrl.l+lastctrl.r,(lastctrl.f+lastctrl.b)*.2,0)).Position - workspace.CurrentCamera.CFrame.Position))*speed_val
                else
                    bv.Velocity = Vector3.new(0,0,0)
                end
                bg.CFrame = workspace.CurrentCamera.CFrame * CFrame.Angles(-math.rad((ctrl.f+ctrl.b)*50*speed_val/maxspeed),0,0)
            end
            ctrl = {f = 0, b = 0, l = 0, r = 0}
            lastctrl = {f = 0, b = 0, l = 0, r = 0}
            speed_val = 0
            bg:Destroy()
            bv:Destroy()
            hum.PlatformStand = false
            tpwalking = false
        else
            local plr = game.Players.LocalPlayer
            local UpperTorso = plr.Character:WaitForChild("UpperTorso")
            local flying = true
            local deb = true
            local ctrl = {f = 0, b = 0, l = 0, r = 0}
            local lastctrl = {f = 0, b = 0, l = 0, r = 0}
            local maxspeed = 50
            local speed_val = 0
            local bg = Instance.new("BodyGyro", UpperTorso)
            bg.P = 9e4
            bg.maxTorque = Vector3.new(9e9, 9e9, 9e9)
            bg.CFrame = UpperTorso.CFrame
            local bv = Instance.new("BodyVelocity", UpperTorso)
            bv.Velocity = Vector3.new(0,0.1,0)
            bv.MaxForce = Vector3.new(9e9, 9e9, 9e9)
            if nowe == true then
                hum.PlatformStand = true
            end
            while nowe == true and hum.Health > 0 do
                game:GetService("RunService").Heartbeat:Wait()
                if ctrl.l + ctrl.r ~= 0 or ctrl.f + ctrl.b ~= 0 then
                    speed_val = speed_val+.5+(speed_val/maxspeed)
                    if speed_val > maxspeed then
                        speed_val = maxspeed
                    end
                elseif not (ctrl.l + ctrl.r ~= 0 or ctrl.f + ctrl.b ~= 0) and speed_val ~= 0 then
                    speed_val = speed_val-1
                    if speed_val < 0 then
                        speed_val = 0
                    end
                end
                if (ctrl.l + ctrl.r) ~= 0 or (ctrl.f + ctrl.b) ~= 0 then
                    bv.Velocity = ((workspace.CurrentCamera.CFrame.LookVector * (ctrl.f+ctrl.b)) + ((workspace.CurrentCamera.CFrame * CFrame.new(ctrl.l+ctrl.r,(ctrl.f+ctrl.b)*.2,0)).Position - workspace.CurrentCamera.CFrame.Position))*speed_val
                    lastctrl = {f = ctrl.f, b = ctrl.b, l = ctrl.l, r = ctrl.r}
                elseif (ctrl.l + ctrl.r) == 0 and (ctrl.f + ctrl.b) == 0 and speed_val ~= 0 then
                    bv.Velocity = ((workspace.CurrentCamera.CFrame.LookVector * (lastctrl.f+lastctrl.b)) + ((workspace.CurrentCamera.CFrame * CFrame.new(lastctrl.l+lastctrl.r,(lastctrl.f+lastctrl.b)*.2,0)).Position - workspace.CurrentCamera.CFrame.Position))*speed_val
                else
                    bv.Velocity = Vector3.new(0,0,0)
                end
                bg.CFrame = workspace.CurrentCamera.CFrame * CFrame.Angles(-math.rad((ctrl.f+ctrl.b)*50*speed_val/maxspeed),0,0)
            end
            ctrl = {f = 0, b = 0, l = 0, r = 0}
            lastctrl = {f = 0, b = 0, l = 0, r = 0}
            speed_val = 0
            bg:Destroy()
            bv:Destroy()
            hum.PlatformStand = false
            tpwalking = false
        end
    end)

    -- 修复up按钮内存泄漏：添加断开连接逻辑
    local upConn = nil
    up.MouseButton1Down:Connect(function()
        if upConn then upConn:Disconnect() end
        upConn = up.MouseEnter:Connect(function()
            while upConn and nowe do
                task.wait()
                local chr = game.Players.LocalPlayer.Character
                if chr and chr:FindFirstChild("HumanoidRootPart") then
                    chr.HumanoidRootPart.CFrame = chr.HumanoidRootPart.CFrame * CFrame.new(0,1,0)
                end
            end
        end)
    end)
    -- 鼠标离开时断开连接
    up.MouseLeave:Connect(function()
        if upConn then
            upConn:Disconnect()
            upConn = nil
        end
    end)

    down.MouseButton1Down:Connect(function()
        local dis
        dis = down.MouseEnter:Connect(function()
            while dis and nowe do
                task.wait()
                local chr = game.Players.LocalPlayer.Character
                if chr and chr:FindFirstChild("HumanoidRootPart") then
                    chr.HumanoidRootPart.CFrame = chr.HumanoidRootPart.CFrame * CFrame.new(0,-1,0)
                end
            end
        end)
        down.MouseLeave:Connect(function()
            if dis then
                dis:Disconnect()
                dis = nil
            end
        end)
    end)

    game:GetService("Players").LocalPlayer.CharacterAdded:Connect(function(char)
        task.wait(0.7)
        local hum = char:FindFirstChildOfClass("Humanoid")
        if hum then
            hum.PlatformStand = false
        end
        local animate = char:FindFirstChild("Animate")
        if animate then
            animate.Disabled = false
        end
    end)

    plus.MouseButton1Down:Connect(function()
        speeds = speeds + 1
        speed.Text = speeds
        if nowe == true then
            tpwalking = false
            for i = 1, speeds do
                task.spawn(function()
                    local hb = game:GetService("RunService").Heartbeat	
                    tpwalking = true
                    local chr = game.Players.LocalPlayer.Character or game.Players.LocalPlayer.CharacterAdded:Wait()
                    local hum = chr:FindFirstChildWhichIsA("Humanoid")
                    while tpwalking and hb:Wait() and chr and hum and hum.Parent do
                        if hum.MoveDirection.Magnitude > 0 then
                            chr:TranslateBy(hum.MoveDirection)
                        end
                    end
                end)
            end
        end
    end)

    mine.MouseButton1Down:Connect(function()
        if speeds == 1 then
            speed.Text = 'cannot be less than 1'
            task.wait(1)
            speed.Text = speeds
        else
            speeds = speeds - 1
            speed.Text = speeds
            if nowe == true then
                tpwalking = false
                for i = 1, speeds do
                    task.spawn(function()
                        local hb = game:GetService("RunService").Heartbeat	
                        tpwalking = true
                        local chr = game.Players.LocalPlayer.Character or game.Players.LocalPlayer.CharacterAdded:Wait()
                        local hum = chr:FindFirstChildWhichIsA("Humanoid")
                        while tpwalking and hb:Wait() and chr and hum and hum.Parent do
                            if hum.MoveDirection.Magnitude > 0 then
                                chr:TranslateBy(hum.MoveDirection)
                            end
                        end
                    end)
                end
            end
        end
    end)

    closebutton.MouseButton1Click:Connect(function()
        main:Destroy()
        -- 断开所有连接，避免内存泄漏
        if upConn then upConn:Disconnect() end
    end)

    mini.MouseButton1Click:Connect(function()
        up.Visible = false
        down.Visible = false
        onof.Visible = false
        plus.Visible = false
        speed.Visible = false
        mine.Visible = false
        mini.Visible = false
        mini2.Visible = true
        main.Frame.BackgroundTransparency = 1
        closebutton.Position =  UDim2.new(0, 0, -1, 57)
    end)

    mini2.MouseButton1Click:Connect(function()
        up.Visible = true
        down.Visible = true
        onof.Visible = true
        plus.Visible = true
        speed.Visible = true
        mine.Visible = true
        mini.Visible = true
        mini2.Visible = false
        main.Frame.BackgroundTransparency = 0 
        closebutton.Position =  UDim2.new(0, 0, -1, 27)
    end)
end)

-- 修复7: 远程脚本加载增加pcall错误处理
local function LoadRemoteScript(url, name)
    local success, err = pcall(function()
        loadstring(game:HttpGet(url, true))()
    end)
    if success then
        print(name .. " 已加载！")
    else
        warn(name .. " 加载失败: " .. tostring(err))
    end
end

Button(Taba, "无敌少侠R15飞行", function()
    LoadRemoteScript("https://rawscripts.net/raw/Universal-Script-Invinicible-Flight-R15-45414", "无敌少侠R15飞行")
end)

Button(Taba, "无敌少侠r6飞行", function()
    LoadRemoteScript("https://raw.githubusercontent.com/ke9460394-dot/ugik/refs/heads/main/%E6%97%A0%E6%95%8C%E5%B0%91%E4%BE%A0%E9%A3%9E%E8%A1%8Cr6.txt", "无敌少侠r6飞行")
end)

Button(Taba, "撸管R6", function()
    LoadRemoteScript("https://pastefy.app/wa3v2Vgm/raw", "撸管R6")
end)

Button(Taba, "撸管R15", function()
    LoadRemoteScript("https://pastefy.app/YZoglOyJ/raw", "撸管R15")
end)

Button(Taba, "悬空", function()
    LoadRemoteScript("https://raw.githubusercontent.com/GhostPlayer352/Test4/main/Float", "悬空")
end)

Button(Taba, "上天堂", function()
    LoadRemoteScript("https://pastefy.app/xV1T3PAi/raw", "上天堂")
end)

Button(Taba, "管理员", function()
    LoadRemoteScript("https://pastebin.com/raw/sZpgTVas", "管理员")
end)

Button(Taba, "上帝模式", function()
    local player = game.Players.LocalPlayer
    local character = player.Character or player.CharacterAdded:Wait()
    
    if character then
        local humanoid = character:FindFirstChildOfClass("Humanoid")
        if humanoid then
            humanoid.MaxHealth = math.huge
            humanoid.Health = math.huge
            
            humanoid.HealthChanged:Connect(function()
                humanoid.Health = math.huge
            end)
            
            print("上帝模式已开启！")
        end
    end
end)

Button(Taba, "透视", function()
    LoadRemoteScript("https://pastefy.app/LE2hzECZ/raw", "透视")
end)

Button(Taba, "禁用摔落伤害脚本", function()
    LoadRemoteScript("https://raw.githubusercontent.com/cytj777i/Fall-injury/main/防止摔落伤害", "禁用摔落伤害脚本")
end)

Button(Taba, "工具包", function()
    LoadRemoteScript("https://cdn.wearedevs.net/scripts/BTools.txt", "工具包")
end)

Button(Taba, "Dex", function()
    LoadRemoteScript("https://raw.githubusercontent.com/renlua/Script-Tutorial/refs/heads/main/dex.lua", "Dex")
end)

Button(Taba, "慢跑侠", function()
    LoadRemoteScript("https://raw.githubusercontent.com/jsjnsj/my-roblox-scripts/refs/heads/main/%E6%85%A2%E8%B7%91%E4%BE%A0", "慢跑侠")
end)

-- 通用标签页 Taba | 仅无限跳跃
local infJumpConn = nil
Toggle(Taba, "无限跳跃", false, function(on)
    local lp = game.Players.LocalPlayer
    if on then
        infJumpConn = game:GetService("UserInputService").JumpRequest:Connect(function()
            local char = lp.Character
            if char and char:FindFirstChildOfClass("Humanoid") then
                char:FindFirstChildOfClass("Humanoid"):ChangeState(Enum.HumanoidStateType.Jumping)
            end
        end)
    else
        if infJumpConn then infJumpConn:Disconnect() end
    end
end)

-- 旋转标签页 TabT | 仅自动旋转（无开关/按钮）
local rotateConn = game:GetService("RunService").RenderStepped:Connect(function()
    local char = game.Players.LocalPlayer.Character
    if char and char:FindFirstChild("HumanoidRootPart") then
        char.HumanoidRootPart.CFrame = char.HumanoidRootPart.CFrame * CFrame.Angles(0, math.rad(5), 0)
    else
        rotateConn:Disconnect()
    end
end)

-- 甩飞与传送标签页 TabV | 仅随机传送按钮（无其他）
Button(TabV, "随机传送", function()
    local char = game.Players.LocalPlayer.Character
    if char and char:FindFirstChild("HumanoidRootPart") then
        local randomPos = Vector3.new(math.random(-100, 100), 50, math.random(-100, 100))
        char.HumanoidRootPart.CFrame = CFrame.new(randomPos)
    end
end)

Button(Taba,"坐下",function()
    local player = game.Players.LocalPlayer
    local character = player.Character or player.CharacterAdded:Wait()
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    if humanoid then
        humanoid.Sit = true
    end
end)

local Players = game:GetService("Players") 
local LocalPlayer = Players.LocalPlayer  

local espConnections = {}
local playerHighlights = {}

local function CreateHighlightForPlayer(player)
    pcall(function()
        if player == LocalPlayer then return end
        
        local character = player.Character or player.CharacterAdded:Wait()
        if playerHighlights[player] then
            playerHighlights[player]:Destroy()
        end
        
        local highlight = Instance.new("Highlight")
        highlight.Name = "PlayerESP"
        highlight.FillColor = Color3.fromRGB(255, 0, 255)
        highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
        highlight.FillTransparency = 0.5
        highlight.OutlineTransparency = 0
        highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
        highlight.Parent = character
        
        playerHighlights[player] = highlight
        
        character.AncestryChanged:Connect(function()
            if not character:IsDescendantOf(game) then
                if playerHighlights[player] then
                    playerHighlights[player]:Destroy()
                    playerHighlights[player] = nil
                end
            end
        end)
    end)
end

local function ClearAllHighlights()
    for player, highlight in pairs(playerHighlights) do
        if highlight then
            highlight:Destroy()
        end
    end
    playerHighlights = {}
end

Toggle(Taba, "透视可关", false, function(on)
    print("透视可关 →", on and "开" or "关")
    
    if on then
        for _, player in ipairs(Players:GetPlayers()) do
            task.spawn(function()
                CreateHighlightForPlayer(player)
            end)
        end
        
        table.insert(espConnections, Players.PlayerAdded:Connect(function(player)
            task.wait(1)
            CreateHighlightForPlayer(player)
        end))
        
        for _, player in ipairs(Players:GetPlayers()) do
            if player ~= LocalPlayer then
                table.insert(espConnections, player.CharacterAdded:Connect(function()
                    task.wait(0.5)
                    CreateHighlightForPlayer(player)
                end))
            end
        end
    else
        for _, conn in ipairs(espConnections) do
            if conn then conn:Disconnect() end
        end
        espConnections = {}
        ClearAllHighlights()
    end
end)

-- 全局变量用于存储所有旋转连接，避免冲突
local rotateConnections={}

local rotateConnections = {}

-- 生成 5 到 500、步长 5 的旋转按钮
for speed = 5, 500, 5 do
    Button(TabT, "旋转" .. speed, function()
        if not selectedPlayer then return end
        local targetHRP = selectedPlayer.Character:FindFirstChild("HumanoidRootPart")
        if not targetHRP then return end

        if rotateConnections[speed] then
            rotateConnections[speed]:Disconnect()
            rotateConnections[speed] = nil
            return
        end

        rotateConnections[speed] = game:GetService("RunService").RenderStepped:Connect(function()
            targetHRP.CFrame *= CFrame.Angles(0, math.rad(speed), 0)
        end)
    end)
end

-- 实时玩家列表下拉菜单
local playerList = {}
for _, plr in ipairs(game.Players:GetPlayers()) do
    table.insert(playerList, plr.Name)
end
local selectedPlayer = nil
local playerDropdown = Dropdown(TabV, "选择玩家", playerList, 1, function(val)
    selectedPlayer = game.Players:FindFirstChild(val)
end)

-- 定时刷新玩家列表
game.Players.PlayerAdded:Connect(function(plr)
    table.insert(playerList, plr.Name)
    playerDropdown:Refresh(playerList)
end)
game.Players.PlayerRemoving:Connect(function(plr)
    local idx = table.find(playerList, plr.Name)
    if idx then
        table.remove(playerList, idx)
        playerDropdown:Refresh(playerList)
    end
end)

-- 按钮1: 传送到选中玩家位置
Button(TabV, "传送到他那里", function()
    local localPlr = game.Players.LocalPlayer
    local localHRP = localPlr.Character and localPlr.Character:FindFirstChild("HumanoidRootPart")
    local targetHRP = selectedPlayer and selectedPlayer.Character and selectedPlayer.Character:FindFirstChild("HumanoidRootPart")
    
    if not localHRP then
        WindUI:Notify({Title = "错误", Content = "自身角色未加载"})
        return
    end
    if not targetHRP then
        WindUI:Notify({Title = "错误", Content = "目标玩家不可用"})
        return
    end
    
    localHRP.CFrame = targetHRP.CFrame * CFrame.new(0, 2, 0)
    WindUI:Notify({Title = "成功", Content = "已传送到 " .. selectedPlayer.Name})
end)

-- 按钮2: 把他传送到我这里
Button(TabV, "他传送到我这里", function()
    local localPlr = game.Players.LocalPlayer
    local localHRP = localPlr.Character and localPlr.Character:FindFirstChild("HumanoidRootPart")
    local targetHRP = selectedPlayer and selectedPlayer.Character and selectedPlayer.Character:FindFirstChild("HumanoidRootPart")
    
    if not localHRP then
        WindUI:Notify({Title = "错误", Content = "自身角色未加载"})
        return
    end
    if not targetHRP then
        WindUI:Notify({Title = "错误", Content = "目标玩家不可用"})
        return
    end
    
    targetHRP.CFrame = localHRP.CFrame * CFrame.new(0, 2, 0)
    WindUI:Notify({Title = "成功", Content = selectedPlayer.Name .. " 已传送到你身边"})
end)

Button(TabV, "随机传送玩家", function()
    local players = game.Players:GetPlayers()
    if #players < 2 then
        WindUI:Notify({Title = "错误", Content = "玩家数量不足"})
        return
    end

    -- 随机选两个不同玩家
    local fromPlr, toPlr
    repeat
        fromPlr = players[math.random(#players)]
        toPlr = players[math.random(#players)]
    until fromPlr ~= toPlr

    local fromHRP = fromPlr.Character and fromPlr.Character:FindFirstChild("HumanoidRootPart")
    local toHRP = toPlr.Character and toPlr.Character:FindFirstChild("HumanoidRootPart")

    if not fromHRP or not toHRP then
        WindUI:Notify({Title = "错误", Content = "目标角色未加载"})
        return
    end

    fromHRP.CFrame = toHRP.CFrame * CFrame.new(0, 2, 0)
    WindUI:Notify({Title = "成功", Content = fromPlr.Name .. " 已传送到 " .. toPlr.Name})
end)

local tpConn = nil

Button(TabV, "无限传送到你那里", function()
    if tpConn then return end
    local localHRP = game.Players.LocalPlayer.Character and game.Players.LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not localHRP or not selectedPlayer then return end
    tpConn = game:GetService("RunService").RenderStepped:Connect(function()
        local targetHRP = selectedPlayer.Character and selectedPlayer.Character:FindFirstChild("HumanoidRootPart")
        if targetHRP then targetHRP.CFrame = localHRP.CFrame * CFrame.new(0, 2, 0) end
    end)
end)

Button(TabV, "停止无限传送", function()
    if tpConn then
        tpConn:Disconnect()
        tpConn = nil
    end
end)

Button(TabV, "选中的玩家甩飞一次", function()
    if not selectedPlayer or not selectedPlayer.Character then return end
    local hrp=selectedPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not hrp then return end
    local power=100000000
    hrp.Velocity=Vector3.new(
        math.random(-power, power),
        power,
        math.random(-power, power)
    )
    WindUI:Notify({Title = "成功", Content = selectedPlayer.Name .. " 已被甩飞"})
end)

Button(TabV, "甩飞选中玩家10次", function()
    if not selectedPlayer or not selectedPlayer.Character then return end
    local hrp = selectedPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not hrp then return end
    local power = 100000000
    local count = 0
    local conn = game:GetService("RunService").RenderStepped:Connect(function()
        hrp.Velocity = Vector3.new(
            math.random(-power, power),
            power,
            math.random(-power, power)
        )
        count += 1
        if count >= 10 then
            conn:Disconnect()
            WindUI:Notify({Title = "成功", Content = selectedPlayer.Name .. " 已被甩飞十次"})
        end
    end)
end)

local flyConn = nil

Button(TabV, "无限甩飞选中玩家", function()
    if flyConn or not selectedPlayer or not selectedPlayer.Character then return end
    local hrp = selectedPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not hrp then return end
    local power = 100000000
    flyConn = game:GetService("RunService").RenderStepped:Connect(function()
        hrp.Velocity = Vector3.new(
            math.random(-power, power),
            power,
            math.random(-power, power)
        )
    end)
end)

Button(TabV, "停止无限甩飞选中玩家", function()
    if flyConn then
        flyConn:Disconnect()
        flyConn = nil
    end
end)

-- 冻结选中玩家（锁死移动）
Button(TabV, "冻结选中玩家", function()
    if not selectedPlayer or not selectedPlayer.Character then return end
    local humanoid=selectedPlayer.Character:FindFirstChildOfClass("Humanoid")
    if humanoid then
        humanoid.WalkSpeed=0
        humanoid.JumpPower=0
    end
end)

-- 解冻选中玩家（恢复默认移动）
Button(TabV, "解冻选中玩家", function()
    if not selectedPlayer or not selectedPlayer.Character then return end
    local humanoid=selectedPlayer.Character:FindFirstChildOfClass("Humanoid")
    if humanoid then
        humanoid.WalkSpeed=16 -- 默认步行速度
        humanoid.JumpPower=50 -- 默认跳跃力度
    end
end)
